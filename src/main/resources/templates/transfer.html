<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="57x57" href="/img/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/img/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/img/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/img/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/img/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/img/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/img/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/img/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/img/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/img/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>양도 계약서</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: auto;
        }

        h1 {
            font-size: 2.5rem;
            color: #495057;
        }

        h2 {
            font-size: 1.5rem;
            color: #007bff;
        }

        .form-label {
            font-weight: bold;
            color: #495057;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .input-group .form-control {
            border-radius: 0.25rem;
        }

        .input-group button {
            border-radius: 0 0.25rem 0.25rem 0;
        }

        .list-group {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }

        .text-secondary p {
            margin: 0.5rem 0;
        }

        .submit-button {
          background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 6px;
            font-size: 16px;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: bold;
            cursor: pointer;
        }
        .btn btn-success px-5 {
          background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 6px;
            font-size: 16px;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: bold;
            cursor: pointer;
        }

        .btn btn-success px-5:hover {
                background-color: #0056b3;
            transform: translateY(-1px);
           }
        .submit-button:hover {
                background-color: #0056b3;
            transform: translateY(-1px);
        }

        .text-center {
            text-align: center;

            text-align: center;
            font-size: 1.8rem;
            color: #007bff;
            margin-bottom: 20px;

        }

        .border {
            border: 1px solid #ced4da;
        }

        .shadow-sm {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .bg-light {
            background-color: #f8f9fa !important;
        }

                .crossLine {
        border-top: 1px solid black;
        }
                .agreement-container {
    display: flex; /* Flexbox 사용 */
    justify-content: space-between; /* 양쪽으로 분산 배치 */
    align-items: flex-start; /* 상단 정렬 */
    margin: 20px 0; /* 위 아래 여백 추가 */
}

.refund-info {
    flex: 1; /* 비율에 따라 크기 조정 */
    margin-right: 20px; /* 오른쪽 여백 */
}

.signature-section {
    flex: 0 0 250px; /* 고정 너비 설정 */
    text-align: center; /* 중앙 정렬 */
}
.box {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border: 2px dashed #007bff;
            border-radius: 6px;
        }


         #signature-pad {
            border: 2px solid #007bff; /* 경계선 색상 */
            border-radius: 6px; /* 둥근 모서리 */
            background-color: #f8f9fa; /* 배경색 */
            width: 250px; /* 고정 너비 */
            height: 100px; /* 고정 높이 */
            max-width: 100%; /* 화면 크기에 맞게 조정 */
            box-sizing: border-box; /* 패딩 및 경계선 포함 */
        }

        #clear-signature {
            background-color: #dc3545; /* 버튼 배경색 */
            color: white; /* 버튼 텍스트 색상 */
            border: none; /* 경계선 없음 */
            padding: 12px 18px; /* 패딩 */
            border-radius: 6px; /* 둥근 모서리 */
            max-width: 250px;
            cursor: pointer; /* 커서 모양 */
            transition: background-color 0.3s, transform 0.2s; /* 부드러운 전환 효과 */
        }

        #clear-signature:hover {
            background-color: #c82333;
            transform: translateY(-1px);
        }

    </style>
</head>
<body>
<a href="/adminPage" class="home-button btn btn-outline-secondary">홈으로</a>
<div class="container mt-5">
    <h1 class="text-center mb-4">회원권 양도</h1>
    <form onsubmit="event.preventDefault(); transferMembership();" class="p-4 border rounded shadow-sm bg-light">
        <h2 class="text-primary mb-3">양도하실 회원님</h2>
        <div class="form-group mb-4">
            <label for="fromMemberSearch" class="form-label">양도하실 회원 검색:</label>
            <div class="input-group">
                <input type="text" id="fromMemberSearch" class="form-control" placeholder="회원 이름을 입력하세요">
                <button type="button" class="btn btn-primary" onclick="searchMember('from')">검색</button>
            </div>
            <ul id="fromMemberResults" class="list-group mt-2"></ul>
            <input type="hidden" id="fromMemberId">
            <div id="fromMemberDetails" class="mt-3 text-secondary">
                <p><strong>이름:</strong> <span id="fromName"></span></p>
                <p><strong>전화번호:</strong> <span id="fromPhone"></span></p>
                <p><strong>카카오톡:</strong> <span id="fromKakao"></span></p>
                <p><strong>회원권 시작일:</strong> <span id="fromMemstart"></span></p>
                <p><strong>회원권 종료일:</strong> <span id="fromMemend"></span></p>
                <p><strong>남은일수:</strong> <span id="fromRemainDays"></span></p>
                <p><strong>남은 휴회 횟수:</strong> <span id="fromRestcount"></span></p>
                <div id="fromLockerDetails"></div>
                <div id="fromShirtDetails"></div>
            </div>
        </div>

        <h2 class="text-primary mb-3">양도받으실 회원님</h2>
        <div class="form-group mb-4">
            <label for="toMemberSearch" class="form-label">양도받으실 회원 검색:</label>
            <div class="input-group">
                <input type="text" id="toMemberSearch" class="form-control" placeholder="회원 이름을 입력하세요">
                <button type="button" class="btn btn-primary" onclick="searchMember('to')">검색</button>
            </div>
            <ul id="toMemberResults" class="list-group mt-2"></ul>
            <input type="hidden" id="toMemberId">
            <div id="toMemberDetails" class="mt-3 text-secondary">
                <p><strong>이름:</strong> <span id="toName"></span></p>
                <p><strong>전화번호:</strong> <span id="toPhone"></span></p>
                <p><strong>카카오톡:</strong> <span id="toKakao"></span></p>
                <p><strong>회원권 시작일:</strong> <span id="toMemstart"></span></p>
                <p><strong>회원권 종료일:</strong> <span id="toMemend"></span></p>
                <p><strong>남은일수:</strong> <span id="toRemainDays"></span></p>
                <p><strong>남은 휴회 횟수:</strong> <span id="toRestcount"></span></p>
                <div id="toLockerDetails"></div>
                <div id="toShirtDetails"></div>
            </div>
        </div>

        <div class="form-group mb-4">
            <label for="daysToTransfer" class="form-label">양도할 일수:</label>
            <input type="number" class="form-control" id="daysToTransfer" required>
        </div>

        <div class="form-group mb-4">
            <label for="price" class="form-label">결제 금액:</label>
            <input type="text" id="price" class="form-control" value="55000" readonly>
        </div>

        <div class="box">
            <div class="agreement-container">
                <div class="refund-info">
                    <div class="crossLine"></div><br>
                    <p><strong>위 양도인의 권리와 의무를 양수받아 만리체육관 관원으로 회칙을 준수할 것을 서약하며 관원으로 시작됨을 인지합니다.</strong></p>
                    <p>    더 이상의 양도는 불가하며 본 합의는 양도인과 양수인 상호 합의하에 이루어진 합의이므로 양수인이 추후 만리 체육관 이용 불가능시에 환불금은 없습니다</p>
                    <p>     * 양도인이 사용한 이전 휴회 기간은 양도일에 포함되지 않습니다.(최초종료일) </p>
                    <p>     *양도받은 회원권의 경우 휴회가 불가능 합니다. </p>
                    <p>    *기존관원 및 가입상담자에게는 양도가 불가능 합니다.</p>
                    <p><strong>양도에 대한 내용을 숙지하였으며, 만리체육관 회원권 양도 신청서 약관에 동의합니다.   </strong></p>                                                 </p>
                </div>
                <div class="signature-section"><br><br><br>
                    <p>[약관 동의 서명란]</p>
                    <canvas id="signature-pad" width="250" height="100" style="border:none;"></canvas>
                    <br>
                    <button type="button" id="clear-signature">서명 지우기</button>
                    <input type="hidden" name="signature" id="signature">
                </div>
            </div>
        </div>


        <div class="text-center">
            <button type="submit" class="btn btn-success px-5">양도하기</button>
        </div>
    </form>
</div>

<script>
    // 회원 검색 함수
    function searchMember(type) {
        const query = type === 'from' ? $('#fromMemberSearch').val() : $('#toMemberSearch').val();
        const resultContainer = type === 'from' ? '#fromMemberResults' : '#toMemberResults';

        if (!query) {
            alert('회원 이름을 입력하세요.');
            return;
        }

        console.log('Search query:', query);

        $.ajax({
            url: '/api/members/search',
            method: 'GET',
            data: { query: query },
            success: function(response) {
                console.log('Search response:', response);
                $(resultContainer).empty();
                if (response.length === 0) {
                    $(resultContainer).append('<li class="list-group-item">No results found</li>');
                } else {
                    response.forEach(member => {
                        $(resultContainer).append(`
                            <li class="list-group-item" onclick="selectMember(${member.id}, '${member.name}', '${member.phone}', '${member.kakao}', '${member.memstart}', '${member.memend}', ${member.remainDays}, '${member.locker}', ${member.locknum}, '${member.lockstart}', '${member.lockend}','${member.restcount}', '${member.shirt}', '${member.shirtstart}', '${member.shirtend}', '${type}')">
                                ${member.name} - ${member.phone}
                            </li>
                        `);
                    });
                }
            },
            error: function(xhr) {
                console.error('Search error:', xhr.responseText);
                alert('회원 검색에 실패했습니다. 다시 시도하세요.');
            }
        });
    }

    // 회원 선택 함수
    function selectMember(id, name, phone, kakao, memstart, memend, remainDays, locker, locknum, lockstart, lockend, restcount, shirt, shirtstart, shirtend, type) {
        if (type === 'from') {
            $('#fromMemberId').val(id);
            $('#fromName').text(name);
            $('#fromPhone').text(phone);
            $('#fromKakao').text(kakao);
            $('#fromMemstart').text(memstart);
            $('#fromMemend').text(memend);
            $('#fromRemainDays').text(remainDays);
            $('#fromRestcount').text(restcount != null ? restcount : '0');


            // Locker 정보 업데이트
            if (locker && locker !== 'null') {
                $('#fromLockerDetails').html(`<b>락커:</b> ${locker} (락카번호: ${locknum}, 시작일: ${lockstart}, 종료일: ${lockend})`);
            } else {
                $('#fromLockerDetails').html('<b>락커 정보 없음</b>');
            }

            // Shirt 정보 업데이트
            if (shirt && shirt !== 'null') {
                $('#fromShirtDetails').html(`<b>운동복:</b> ${shirt} (시작일: ${shirtstart}, 종료일: ${shirtend})`);
            } else {
                $('#fromShirtDetails').html('<b>운동복 정보 없음</b>');
            }
        } else {
            $('#toMemberId').val(id);
            $('#toName').text(name);
            $('#toPhone').text(phone);
            $('#toKakao').text(kakao);
            $('#toMemstart').text(memstart);
            $('#toMemend').text(memend);
            $('#toRemainDays').text(remainDays);
            $('#toRestcount').text(restcount != null ? restcount : '0');

            // Locker 정보 업데이트
            if (locker && locker !== 'null') {
                $('#toLockerDetails').html(`<b>락커:</b> ${locker} (락카번호: ${locknum}, 시작일: ${lockstart}, 종료일: ${lockend})`);
            } else {
                $('#toLockerDetails').empty();
            }

            // Shirt 정보 업데이트
            if (shirt && shirt !== 'null') {
                $('#toShirtDetails').html(`<b>운동복:</b> ${shirt} (시작일: ${shirtstart}, 종료일: ${shirtend})`);
            } else {
                $('#toShirtDetails').empty();
            }
        }
    }

    // 회원권 양도 함수
    function transferMembership() {
        const fromMemberId = $('#fromMemberId').val();
        const toMemberId = $('#toMemberId').val();
        const daysToTransfer = $('#daysToTransfer').val();
        const price = document.getElementById('price').value;


        if (!fromMemberId || !toMemberId || !daysToTransfer) {
            alert("모든 필드를 입력하세요.");
            return;
        }

        console.log('Transfer request:', {
            fromMemberId: fromMemberId,
            toMemberId: toMemberId,
            daysToTransfer: daysToTransfer
        });

        $.ajax({
            url: '/api/transfers/transfer',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                fromMemberId: fromMemberId,
                toMemberId: toMemberId,
                daysToTransfer: daysToTransfer,
                price: price

            }),
            success: function(response) {
                alert('회원권 양도에 성공했습니다.');
                console.log('Transfer success response:', response);
            },
            error: function(xhr) {
                alert('Error: ' + xhr.responseText);
                console.error('Transfer error response:', xhr.responseText);
            }
        });
    }

</script>
<script>
    // Canvas 초기화
 const canvas = document.getElementById('signature-pad');
 const ctx = canvas.getContext('2d');
 let isDrawing = false;

 // 초기 텍스트 그리기
 function drawPlaceholderText() {
     ctx.font = '20px Arial'; // 글꼴과 크기 설정
     ctx.fillStyle = 'gray'; // 텍스트 색상 설정
     ctx.textAlign = 'center';
     ctx.textBaseline = 'middle';
     ctx.fillText('(서명)', canvas.width / 2, canvas.height / 2);
 }

 // 서명 시작
 canvas.addEventListener('mousedown', () => {
     isDrawing = true;
     ctx.beginPath();
 });

 // 서명 그리기
 canvas.addEventListener('mousemove', (event) => {
     if (isDrawing) {
         ctx.lineTo(event.offsetX, event.offsetY);
         ctx.stroke();
     }
 });

 // 서명 끝
 canvas.addEventListener('mouseup', () => {
     isDrawing = false;
 });

 // 서명 지우기 기능
 document.getElementById('clear-signature').addEventListener('click', function() {
     ctx.clearRect(0, 0, canvas.width, canvas.height);
     drawPlaceholderText(); // 서명 지우기 후 텍스트 다시 그리기
 });



 // 페이지 로드 시 텍스트 그리기
 window.onload = function() {
     drawPlaceholderText();
 };

</script>
</body>
</html>
